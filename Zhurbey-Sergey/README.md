# Фича - семейный аккаунт

## 1. Что улучшаем и зачем, описание и мотивация
Добавляем новую фунциональность - семейный акканут. В идее моей реализаации - это скорее "группы", один пользователь
может присоединиться к нескольим семьям, в пределах которых у пользователей сохраняются их стандартные, уже привзяанные
методы оплаты. В сеьме появляются следующие функциональные возможнсоти:

* возомжность оплаты поездки члена семьи, другим ее участником(упрощает сценарий оплаты, в случае если у одного
пользователя нет денег. Нет необходимости проводить переводы между банковскими картами, а также оплата поездки члену 
семьи снимет с карты оплачивающего ровно сумму, равную стоимости поездки по текущему тарифу, в отличие от кейса с 
переводом средств, ведь цена на такси может изменяться в каждый момент времени). Для запроса оплаты член семьи выбирает
маршрут, а затем просит члена группы семьи оплатить поездку. Второму приходит оповещение, и он, используя свои
привязанные методы оплаты, оплачивает при согласии поезду первого.
* возможность разделить оплату за поездку между членами семьи. Несколько участников семьи используют одно такси, для
поездки в несколько пунктов, находящихся недалеко друг от друга. Один участник семьи формирует заказ на поездку,
отмечает участников семьи, которые разделят с ним позедку, после чего стоимость поровну делится между всеми
отмеченными пользователями. Всем участникам приходит оповещение с требованием оплаты. Здесь также можно использовать
первую возможность оплаты одним членом семьи за другого.

Преимущества:
* добавление новых сценариев работы с приложением, проработка функциональных возможностей для большего удобства
использования клиентами
* привлечение новых пользователей, семейный аккаунт в своем роде служит рекламной акцией, люди знающие об этой новой
функциональности стараются привлечь своих друзей


## 2. MVP
В качестве MVP можно добавить всю функциональность для работ с группами - объединение в группы, добавление и удаление 
участнкиов. Поверх этого для MVP версии можно реализовать например только часть с оплатой поездок
членов семьи другими членами, а часть с групповой оплатой поездок реализовать позже.

Итого MVP реализует полную функциональность по работе с группами, и часть от списка возможностей,
которые мы хотим вложить в нашу новую фичу в целом.

`В проработке фичи буду описывать именно MVP.`


## 3. базовая архитектура
Для хранения лучше всего подойдет реляционная модель, в качестве СУБД можно взять PostgreSQL. Новую логику для фичи
можно вынести в отдельный микросервис. Примерная структура новых таблиц будет выглядеть так(картинка):

<img width="942" alt="image" src="https://user-images.githubusercontent.com/44731679/121331014-2cef9500-c91f-11eb-9138-6dab92114cbe.png">

Мы просто объединяем пользователей в группы, по прежнему ссылаясь на их старые способы оплаты и общие данные.

В существующей таблице истории заказов возможно тоже нужно будет добавить несколько столбцов:
1. Содержащий ссылку на члена семьи, если заказ был оплачен по запросу, не самим клиентом
2. Для реализации правильного сохранения истории групповых поездок(не входит в MVP), вероятно нужно будет добавить
связь many to many, чтобы соотносить заказ и всех участников семьи, которые учавствовали в поездке.

Основные операции в MVP:
* Создание семьи
* Добавление пользователя в семью ее создателем
* Удаление пользователя из семьи
* Возможность назначить нового создателя(владельца семьи)
* Возомжность покинуть семью
* Возможность запросить другого члена семьи оплатить выбранную поездку(Члену семьи приходит оповещение с запросом
в приложении)
* Возможность оплатить заказ по запросу(После согласия на оплату член семьи использует свои стандартные методы оплаты)


## 4. api yaml, несколько ручек
Детально описал основные ручки по работе с группами и добавлению пользователей.  
Не описал удаление пользователя из семьи и возможность покинуть семью - запросы простые и от части дублируют 
предыдущие. Запрос на оплату пользователем семьи по сути представляет собой
передачу сообщения через сервер другому пользователю - ручка API максимально простая, также не описывал.  
Оплата заказа по запросу при согласии(последняя операция в MVP) реализуется в большей степени базируясь на базовую,
уже существующую в системе ручку по оформлению заказа - в нашем случае нужно лишь добавить несколько новых полей при
записи в таблицы, для этого можно написать ручкую в нашем новом микросервисе, которая будет принимать данные по заказу,
приводить к нужной форме и дергать основую ручку по заказам. Эту ручку сложно описать не имея базовую.

[Ссылка на api](api.yaml)


## 5. Несколько тестов разного уровня
Основные тесты которые хотелось бы написать -  тестирование ручек api, unit-тестирование сложных элементов
бизнес-логики.

Также стоит отметить несколько граничных случаев:
* Назначение новым владельцем семьи пользователя, не являющегося ее участником
* Назначение новым владельцем семьи пользователя, который не существует
* Добавление пользователя по email'у, который не зарегестирован
* Все действия с API с группами, которые не существуют
* Повторное добавление человека в одну и ту же группу
* Группу покидает ее создатель(права передаются самому старому участнику)  
...


## 6. дизайн ввода фичи, как и на ком, основные метрики - бизнесовые и технические
Основная метрика - количество пользователей, объединившихся в группы. Также хорошой метрикой будет
количество заказов, оплаченных с использованием новой функциональности.  
В первую очередь можно включить для наиболее активных пользователей, с большим количеством заказов, либо для
пользователей, которые часто отмечают несколько пунктов в маршруте поездок, вероятно, именно такие пользователи
часто используют такси группами, хотя конечно это не гарантированно(логика для фичи разделения стоимости заказа).  
