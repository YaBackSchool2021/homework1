# Рейтинг пассажира
Предлагается ввести в функциональность сервиса возможность выставления рейтинга пассажиру водителем.

Главная гипотеза:
> если дать водителю возможность оценивать пассажира, то комфорт и безопасность поездок увеличатся, потому что водитель будет иметь возможность отказаться от поездки с низким рейтингом, а пассажир будет знать, что его оценивают точно так же, как он сам оценивает водителя.

## Постановка задачи, проработка идеи
Дать возможность водителю выставлять своему пассажиру рейтинг по окончании поездки и просматривать его перед принятием поездки.

Данное решение призвано сделать поездки более комфортными, ведь как пассажиру необходимо чувствовать себя в безопасности во время поездки, так и водителю важно чувствовать безопасность за себя, свои деньги, время, машину и пр. Водитель получит часть информации о поездке еще до ее начала, а клиент станет более внимателен к себе как к пассажиру, что в совокупности увеличит взаимное доверие.

В связи с этим, предлагается разделить рейтинг на несколько составляющих:
- Коммуникация и пунктуальность (пассажир прибыл к машине без ожидания, объяснил при необходимости особенности проезда к месту начала поездки)
- Тишина и безопасность (пассажир не мешал водителю во время поездки, бережно относился к сохранности и чистоте машины и салона)
- Беседа (интересный собеседник, при желании можно завести разговор; необязательная оценка, не учитывается при вычислении общего рейтинга)

Люди меняются, а за ними и оценки, поэтому рассчитывать рейтинг по оценкам водителей предлагается исходя из последних 20 поездок.

Для первоначального восприятия предлагается также расчитывать общий рейтинг как взвешенную сумму отдельных оценок.

Предлагается также дать водителю возможность отложить оценку поездки и напомнить о ней позже.

Отдельного анализа требует способ применения полученных оценок: оставить рейтинг просто информацией о пассажире для субъективной оценки водителями или же учитывать его при создании поездки, например, дать возможность водителям ограничить снизу рейтинг пассажиров при поиске заказа или снижать цены и делать особые предложения самым высоко оцененным пассажирам.

Для экономии времени водителя можно также дать ему возможность не указывать отдельные оценки, а дать лишь общую (назовем ее "быстрой" оценкой). В таком случае выставленная оценка дублируется в каждую из обязательных составляющих общей оценки, а отзыв помечается для его учета с меньшим весом (такой отзыв менее объективен, ведь водитель потратил меньше времени на его проработку). Через некоторое время следует предложить водителю уточнить оценку.

Дополнительная фича: история оценок пассажира (в виде графика). Целесообразность под вопросом, так как, вероятно, у водителя нет лишнего рабочего времени на просмотр графиков и выводы – вычисленные оценки для него информативнее.

![use case diagram](http://www.plantuml.com/plantuml/png/RP0zpi8m38RtdCBZzmtb00oeMrSa3e1COuBLDAaSbnyXxauZI5K4awttUVqChfEYwDXxu-cee164tKd1ib2h78D97OS11NiOiEtGqKvldY1Z3CwJmLQZG1FVorQYcU5qan85Hx8NL0uExWPo1QeA_j9uw5dXHVuNuCnqMSIbQ4cHFTc2OBMPMOdMG5UbO0ryQhAtYINzhShaM_GmzJIc5pq1)

## MVP
Для максимально сжатого MVP предлагается реализация только общего рейтинга: выставление только общей оценки от 1 до 5, расчет текущего рейтинга как в полной версии, отображение текущего рейтинга при принятии заказа – минимальная функциональность, позволяющая оценить целесообразность идеи.

Следующий этап – разделение оценки на описанные составляющие, добавление новых пунктов, возможная интеграция оценки в процесс подбора заказов.

## Реализация

### Стек технологий
- Python
    + быстрый старт
    + невысокая нагрузка
- PostgreSQL
    + фиксированная разметка данных
    + часть работы (например, расчет текущего рейтинга) можно при необходимости переложить на БД

### Архитектура
Фича не самая большая и профита от реализации в монолите или существующих сервисах меньше, чем возможных осложнений, поэтому предлагается реализовать микросервис.

![architecture](http://www.plantuml.com/plantuml/png/SoWkIImgAStDuShBJqbL22ZAXp3SyxbI4aiIanABKnLSd1GIYnMK0lABIzABKeC3VPIuYbAJInBpqdDI5GeIYujJyz9JY-AB4aioyzAvW4OewEhQOKguun175m2hSd7YSaZDIm4w3000)

### Взаимодействие
Участники взаимодействия:
- Приложение водителя (Про)
- Приложение клиента (Клиент)
- Приложение рейтинга (Сервер)
- База данных (БД)

![pro sequence diagram](http://www.plantuml.com/plantuml/png/SoWkIImgAStDuIe0qfd9cGM9UIKA5-PVRBYm3rLeuOMjGC5D898h9R4aCIcnE5NXmiGBKxWWgXLqxL0KMIa4-0U7AEWN9PPavgNhgnHbfgJ6PwPm8Qi1wW4ROGNIkUzYAr1ymuMz5tPSRBhOem3aRBsmysBJXHr0eSse-cnqTQ4Q_RsXzeF4q1nWP608aiVfG7TNXFkISp9JyqhqLI0q7eTE0elklTXCWYClpBimIq7ZmW9ajPhut6q0T3Uc1jmXxHZYx45iK8DDtG8Cw5qWaq460bLi8D4tX1pFvP2Qbm9CLW00)

![go sequence diagram](http://www.plantuml.com/plantuml/png/SoWkIImgAStDuIe0qfd9cGM9UIKA5sPTs7rXnuMj5_PUR4ALM7XXwyM62vj095TAOabYKc9ngiA5YHUcS27hKT2rGr5gfU3k6gAWNvHOafcNhf-SavcQLwAl0g7ZCrEuaDK2zO8Dj5AuC0d41vhNVB7fOey2aBdrmiwBJK1BzbxOZAh7HbSNfcdUXLaA6XSM8AlLH74SI36QwumC31JylJ6rEQJcfG331W00)

```yaml
openapi: 3.0.0
info:
    title: 'Passenger rating app'
    version: '1.0'

paths:
    /rating/client/{client_id}:
        parameters:
          - in: path
            name: client_id
            required: true
            schema:
                type: integer
        get:
            description: 'Client rating'
            responses:
                '200':
                    description: 'OK'
                    content:
                        application/json:
                            schema:
                                $ref: '#/components/schemas/ClientRating'
                '404':
                    description: 'Not found'

    /rating/{ride_id}:
        parameters:
          - in: path
            name: ride_id
            required: true
            schema:
                type: integer
        post:
            description: 'Submit rating'
            requestBody:
                content:
                    application/json:
                        schema:
                            $ref: '#/components/schemas/RideRating'
            responses:
                '201':
                    description: 'Created'
                '400':
                    description: 'Bad request'
        patch:
            description: 'Update rating by ride id'
            requestBody:
                content:
                    application/json:
                        schema:
                            $ref: '#/components/schemas/RideRating'
            responses:
                '200':
                    description: 'OK'
                '400':
                    description: 'Bad request'
                '404':
                    description: 'Not found'

components:
    schemas:
        RideRating:
            type: object
            additionalProperties: false
            properties:
                driver_id:
                    type: integer
                quick_rating:
                    type: boolean
                comm:
                    type: integer
                safe:
                    type: integer
                talk:
                    type: integer
            required:
              - driver_id
              - quick_rating
              - comm
              - safe
              - talk
                
        ClientRating:
            type: object
            additionalProperties: false
            properties:
                total:
                    type: number
                comm:
                    type: integer
                safe:
                    type: integer
                talk:
                    type: integer
            required:
              - total
              - comm
              - safe
              - talk

```

### Тестирование
Провести юнит тестирование компонентов для подтверждения работоспособности приложения. Протестировать поведение в случае отсутствия оценок за последние поездки, отстутствия самих оценок.

Провести интеграционное тестирование для подтверждения работоспособности приложения в инфраструктуре.

~~Провести E2E тестирование для валидации поведения в инфраструктуре (в особенности важно в случае интеграции влияния рейтинга на подбор заказов).~~ Проводить E2E тестирование для такой небольшой фичи может быть неоправданно накладно, пока она не влияет на работу остальных сервисов.

Провести нагрузочное тестирование для подтверждения соответствия отказоустойчивости основному приложению. Кейсы высокой нагрузки такие же, как и у ближайших приложений и сценариев, так как рейтинг отображается перед каждым поиском поездки и выставляется потенциально по окончании каждой поездки.

### Внедрение и эксперимент
Включение и проверка на уровне разработчика/команды, по понятным причинам, невозможна. В связи с этим, предлагается плавная раскатка с наиболее высоко оцененных пассажирами водителей и предпочтителей топовых тарифов со стороны клиентов – их меньше и велика вероятность, что они уделят новой фиче больше внимания.

Предлагается в различных группах пользователей (например, по городу) с помощью кваргов экспериментировать с весами отдельных составляющих оценки, весом "быстрых" оценок, числом последних поездок для расчета рейтинга.

Отслеживать предлагается косвенные предпосылки главной гипотезы, а именно: частоту обращения к подробной оценке водителями и клиентами и ее выставления водителями, частоту отказов от поездки по причине низкого рейтинга. Можно отслеживать retention, так как этому способствует ожидаемое увеличение уверенности пассажира и клиента в добросовестности друг друга; длительность сессии просмотра рейтинга – мы хотим, чтобы он был подробным и информативным, но не отвлекал водителя от работы.
